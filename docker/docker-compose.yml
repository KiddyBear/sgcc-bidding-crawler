version: '3.8'

# 国网招标爬虫 - Docker Compose 配置
# 服务名称：sgcc-crawler

services:
  sgcc-crawler:
    # 使用本地构建的镜像
    build:
      context: ..
      dockerfile: docker/Dockerfile
    
    # 容器名称
    container_name: sgcc-crawler
    
    # 镜像名称和标签
    image: sgcc/crawler:latest
    
    # 端口映射：宿主机端口 -> 容器端口
    ports:
      - "${APP_PORT:-8080}:8080"
    
    # 数据卷挂载
    volumes:
      # 应用数据持久化
      - ${DATA_VOLUME:-/data/sgcc_bidding_crawler}:/app/data
      # 日志持久化（可选）
      - ./logs:/app/logs
      
    # 环境变量配置
    environment:
      # JVM 参数优化
      - JAVA_OPTS=-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
      # 应用配置文件激活
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      # 数据库配置（从环境变量读取）
      - SPRING_DATASOURCE_URL=${DB_URL:-jdbc:mysql://host.docker.internal:3306/sgcc_crawler?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true}
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME:-inspection}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-ENC(vijNB1Ji+VTR3KJ9Jueu52CIg7bvFmnN)}
      # 钉钉配置（从环境变量读取）
      - DINGTALK_WEBHOOK=${DINGTALK_WEBHOOK:-}
      - DINGTALK_SECRET=${DINGTALK_SECRET:-}
      - DINGTALK_ENABLED=${DINGTALK_ENABLED:-true}
      # 爬虫配置
      - CRAWLER_HEADLESS=${CRAWLER_HEADLESS:-true}
      - CRAWLER_MAX_PAGES=${CRAWLER_MAX_PAGES:-5}
      - CRAWLER_REQUEST_INTERVAL=${CRAWLER_REQUEST_INTERVAL:-2000}
      
    # 容器重启策略：总是重启（开机自启）
    restart: always
    
    # 容器健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # 网络配置
    networks:
      - sgcc-network
    
    # 容器标签（用于监控和管理）
    labels:
      - "com.sgcc.app.name=sgcc-bidding-crawler"
      - "com.sgcc.app.version=1.0.0"
      - "com.sgcc.environment=production"

# 自定义网络配置
networks:
  sgcc-network:
    driver: bridge
    name: sgcc-crawler-network

# 卷配置（如果需要命名卷）
# volumes:
#   sgcc-data:
#     driver: local
#     driver_opts:
#       type: none
#       o: bind
#       device: ${DATA_VOLUME:-/data/sgcc_bidding_crawler}